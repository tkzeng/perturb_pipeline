# Snakemake Pipeline Rules Documentation

This document provides a brief description of each rule in the GW_PERTURB analysis pipeline Snakefile.

## Core Processing Rules

### `rule all`
**Lines: 310-313**  
The main target rule that defines all expected outputs. Uses the `get_all_outputs()` function to generate a comprehensive list of all pipeline outputs based on the configured combinations (default: main+raw and all+merged).

### `rule count_reads`
**Lines: 315-337**  
Counts the number of reads in R1 and R2 FASTQ files for each sample. Uses pigz for fast decompression and outputs read counts to a simple CSV file. Essential for calculating sequencing depth and saturation analysis.

## Kallisto/Bustools Processing

### `rule kallisto_gex`
**Lines: 342-391**  
Runs kallisto-bustools for gene expression (GEX) quantification. Processes nascent and mature RNA using the NAC workflow with configurable strand option. Uses `--mm` flag for fractional assignment of multimapping reads. Requires barcode recovery completion if processing recovered reads.

### `rule kallisto_guide`
**Lines: 393-433**  
Runs kallisto-bustools for guide RNA quantification using the kite workflow. Similar to kallisto_gex but uses guide-specific reference files and settings. Critical for perturbation barcode detection in high MOI experiments.

### `rule kallisto_gex_subsampled`
**Lines: 436-481**  
Runs kallisto-bustools on subsampled GEX data at different fractions (0.1, 0.25, 0.5, 0.75) for saturation analysis. Calculates target read counts based on fraction and uses `--max-reads` parameter to limit processing.

### `rule kallisto_guide_subsampled`
**Lines: 483-525**  
Runs kallisto-bustools on subsampled guide data for guide saturation analysis. Similar to kallisto_gex_subsampled but for guide samples with appropriate memory allocations.

## Barcode Processing

### `rule generate_combined_whitelist`
**Lines: 527-538**  
Generates a combined barcode whitelist for bustools inspect operations. Creates all possible barcode combinations from the input barcode file.

### `rule inspect_bus_files`
**Lines: 540-575**  
Runs bustools inspect on all BUS files generated by kallisto to extract read statistics. Creates inspect JSON files needed for downstream QC metric calculations.

### `rule merge_all_fastqs`
**Lines: 580-618**  
Merges all FASTQ sources for comprehensive analysis: main raw + main recovered + undetermined raw + undetermined recovered. Ensures proper UMI deduplication across all read sources.

## Filtering and Annotation

### `rule filter_and_annotate_sublibrary`
**Lines: 622-684**  
Filters and annotates sublibrary data by combining GEX and guide samples. Key operations include: 1) Filtering GEX to top 3x expected cells + 5x random background cells (or keeping all with --skip-filtering), 2) Filtering guide data to match GEX barcodes, 3) Combining datasets and adding guide counts/assignments to obsm, 4) Adding comprehensive gene annotations from GENCODE, 5) Calculating QC metrics (mitochondrial %, counts, genes), 6) Mapping cells to samples/wells using Parse Bio barcodes, 7) Outputting annotated h5ad and MTX files for downstream cell calling.

## Quality Control

### `rule fastp_qc`
**Lines: 686-712**  
Runs fastp for basic FASTQ quality control. Generates HTML and JSON reports with read quality metrics, adapter content, and other sequence statistics.

### `rule calculate_read_statistics`
**Lines: 715-747**  
Calculates comprehensive read mapping statistics from kallisto outputs. Integrates information from kb_info.json and bustools inspect to compute mapping rates, duplication rates, and other metrics.

### `rule cell_calling_analysis`
**Lines: 749-790**  
Performs comprehensive cell calling analysis using seven different methods: 1) Expected cell count (top N barcodes), 2) Simple UMI threshold, 3-5) EmptyDrops with FDR thresholds of 0.001, 0.01, and 0.05, 6) BarcodeRanks knee point, 7) BarcodeRanks inflection point. Runs DropletUtils (EmptyDrops and barcodeRanks) via R script on the pre-filtered matrix from filter_and_annotate_sublibrary. Calculates percentage of UMIs captured by each method and saves results including cell barcodes for each approach.

### `rule cell_calling_plots`
**Lines: 792-834**  
Generates visualization plots for cell calling results including knee plots, rank plots, and cell count comparisons across different methods. Outputs follow the QC report directory structure.

### `rule calculate_qc_metrics_stratified`
**Lines: 838-924**  
Calculates comprehensive QC metrics at three stratification levels using multiple inputs:
- **Inputs**: 1) Annotated h5ad (GEX+guide data), 2) Cell calling results, 3) GEX read statistics, 4) Guide read statistics
- **Metrics calculated**: For each cell calling method: cell counts, median/mean UMIs per cell, genes per cell, mitochondrial %, total UMIs in cells, reads per UMI (sample-level only), guides per cell at multiple cutoffs (1-5), fraction of cells with guides, guide diversity metrics, and equivalent metrics for background (non-cells)
- **Sample level**: Includes all read mapping statistics from both GEX and guide samples (total reads, mapped %, duplication rate, etc.)
- **Biological sample level**: Groups cells by biological replicate, shows contributing wells
- **Well level**: Groups cells by plate position, shows biological sample mapping
- **Outputs**: TSV files and per-cell distribution plots (violin plots for UMIs, genes, mito%, guide UMIs)

## Saturation Analysis

### `rule umi_saturation_analysis`
**Lines: 926-974**  
Analyzes UMI saturation for GEX samples using subsampled data points. Calculates saturation curves and generates plots showing the relationship between sequencing depth and unique molecular identifiers.

### `rule umi_saturation_analysis_guide`
**Lines: 976-1026**  
Analyzes UMI saturation for guide samples. Uses cell calling results from the paired GEX sample to define valid cells for guide saturation calculations.

## Undetermined Read Recovery

### `rule check_undetermined_barcodes`
**Lines: 1028-1063**  
Analyzes undetermined reads to recover those with correctable index errors. Processes pool-level undetermined FASTQ files and generates recovery statistics.

### `rule create_undetermined_fastq`
**Lines: 1065-1099**  
Creates sample-specific FASTQ files from recovered undetermined reads. Uses sample and primer information to assign reads to appropriate samples with a minimum read threshold.

### `rule barcode_recovery`
**Lines: 1102-1144**  
Recovers reads with correctable cell barcode errors from both main and undetermined sources. Uses configurable shift parameters to identify and correct barcode mismatches.

## Consolidation and Reporting

### `rule consolidate_qc_metrics`
**Lines: 1146-1198**  
Consolidates QC metrics across all samples using simple concatenation. Creates separate consolidated files for sample-level, biological sample-level, and well-level metrics.

### `rule visualize_consolidated_qc`
**Lines: 1201-1261**  
Generates comprehensive visualizations for consolidated QC metrics from TSV files. Creates three types of plots based on metric type and stratification level:
- **Horizontal point plots**: For most metrics (sample/biological sample level), sorted by value with sample labels. Both linear and log scale versions generated.
- **Scatter plots**: For cell-based metrics (e.g., UMIs/genes per cell) plotted against mean reads per cell, and for group-level metrics (e.g., duplication rate) plotted against total reads. Shows relationship between sequencing depth and metric values.
- **Heatmaps**: For well-level metrics, displayed as 96-well plate layout with color-coded values.
- **Plot organization**: Separates outputs into "consolidated_general" (metrics without cell calling methods) and "consolidated_cell_based" (metrics specific to cell calling methods like EmptyDrops).
- **Parallel processing**: Uses multiprocessing to generate plots efficiently.
- **Smart filtering**: Skips certain metrics that aren't informative as plots, avoids log scale for percentage/count metrics.

### `rule process_pool_metrics`
**Lines: 1264-1293**  
Processes and visualizes pool-level metrics (only for main/raw combination). Consolidates pool statistics and generates pool-specific visualizations.

### `rule generate_qc_report`
**Lines: 1296-1338**  
Packages all QC outputs into a self-contained dashboard for laptop viewing. Uses the Streamlit dashboard script and creates a timestamped archive with filtered data for efficient loading.

### `rule calculate_pool_statistics`
**Lines: 1341-1368**  
Calculates pool-level statistics including the fraction of undetermined reads. Aggregates read counts across all samples in a pool and compares to undetermined reads.