<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Single-Cell Perturbation QC Report</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.4/css/lightbox.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body>
    <div id="app" x-data="qcReport" x-init="init()" @click.away="handleViewChange(currentView)">
        <!-- Navigation Sidebar -->
        <nav id="sidebar">
            <h2>QC Report</h2>
            <div class="nav-section">
                <ul>
                    <li><a href="#" @click.prevent="currentView = 'overview'; handleViewChange('overview')" 
                           :class="{'active': currentView === 'overview'}" class="nav-link">Overview</a></li>
                    <li><a href="#" @click.prevent="currentView = 'cell-calling'; handleViewChange('cell-calling')" 
                           :class="{'active': currentView === 'cell-calling'}" class="nav-link">
                           Cell Calling 
                           <span class="plot-count" x-text="`(${plotCounts.cell_calling || 0})`"></span>
                    </a></li>
                    <li><a href="#" @click.prevent="currentView = 'saturation'; handleViewChange('saturation')" 
                           :class="{'active': currentView === 'saturation'}" class="nav-link">
                           UMI Saturation
                           <span class="plot-count" x-text="`(${plotCounts.saturation || 0})`"></span>
                    </a></li>
                    <li><a href="#" @click.prevent="currentView = 'per-cell-qc'; handleViewChange('per-cell-qc')" 
                           :class="{'active': currentView === 'per-cell-qc'}" class="nav-link">
                           Per-Cell QC
                           <span class="plot-count" x-text="`(${plotCounts.per_cell || 0})`"></span>
                    </a></li>
                    <li><a href="#" @click.prevent="currentView = 'compare-samples'; handleViewChange('compare-samples')" 
                           :class="{'active': currentView === 'compare-samples'}" class="nav-link">Compare Samples</a></li>
                    <li><a href="#" @click.prevent="currentView = 'consolidated'; handleViewChange('consolidated')" 
                           :class="{'active': currentView === 'consolidated'}" class="nav-link">
                           Consolidated Metrics
                           <span class="plot-count" x-text="`(${plotCounts.consolidated || 0})`"></span>
                    </a></li>
                </ul>
            </div>
            
            <!-- Filters -->
            <div id="filters">
                <h3>Filters</h3>
                <div class="filter-group">
                    <label for="pool-filter">Pool:</label>
                    <select id="pool-filter" class="filter-select" x-model="filters.pool">
                        <option value="">All Pools</option>
                        <template x-for="pool in availablePools" :key="pool">
                            <option :value="pool" x-text="pool"></option>
                        </template>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="sample-filter">Sample:</label>
                    <select id="sample-filter" class="filter-select" x-model="filters.sample">
                        <option value="">All Samples</option>
                        <template x-for="sample in availableSamples" :key="sample">
                            <option :value="sample" x-text="sample"></option>
                        </template>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="method-filter">Method:</label>
                    <select id="method-filter" class="filter-select" x-model="filters.method">
                        <option value="">All Methods</option>
                        <template x-for="method in availableMethods" :key="method">
                            <option :value="method" x-text="method"></option>
                        </template>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="source-filter">Source:</label>
                    <select id="source-filter" class="filter-select" x-model="filters.source">
                        <option value="">All Sources</option>
                        <template x-for="source in organization.sources || []" :key="source">
                            <option :value="source" x-text="source"></option>
                        </template>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="processing-filter">Processing:</label>
                    <select id="processing-filter" class="filter-select" x-model="filters.processing">
                        <option value="">All Processing</option>
                        <template x-for="proc in organization.processing || []" :key="proc">
                            <option :value="proc" x-text="proc"></option>
                        </template>
                    </select>
                </div>
                <button @click="resetFilters()" class="btn btn-secondary">Reset Filters</button>
            </div>
            
            <!-- Info -->
            <div class="sidebar-info">
                <p>Generated: <span x-text="generatedDate"></span></p>
                <p>Samples: <span x-text="totalSamples"></span></p>
                <p x-show="filteredPlots.length < currentPlots.length" class="filter-info">
                    Showing <span x-text="filteredPlots.length"></span> of <span x-text="currentPlots.length"></span> plots
                </p>
            </div>
        </nav>
        
        <!-- Main Content -->
        <main id="content">
            <div x-show="loading" class="loading-spinner">Loading QC Report...</div>
            
            <!-- Category loading indicator -->
            <div x-show="!loading && Object.values(categoryLoading).some(v => v)" class="loading-spinner">
                Loading plots...
            </div>
            
            <div x-show="!loading && !Object.values(categoryLoading).some(v => v)" x-cloak id="content-area">
                <!-- Overview Section -->
                <div x-show="currentView === 'overview'" class="content-section">
                    <h1>QC Report Overview</h1>
                    <p>This report contains quality control metrics for single-cell perturbation sequencing data.</p>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" x-text="gexSamples.length"></div>
                            <div class="stat-label">GEX Samples</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" x-text="guideSamples.length"></div>
                            <div class="stat-label">Guide Samples</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" x-text="availablePools.length"></div>
                            <div class="stat-label">Pools</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" x-text="manifest.total_plots || 0"></div>
                            <div class="stat-label">Total QC Plots</div>
                        </div>
                    </div>
                    
                    <h2>Sample Information</h2>
                    <div class="table-container">
                        <table id="sample-table" class="display"></table>
                    </div>
                </div>
                
                <!-- Cell Calling Section -->
                <div x-show="currentView === 'cell-calling'" class="content-section">
                    <h1>Cell Calling Analysis</h1>
                    <p>Barcode rank plots showing the results of different cell calling methods.</p>
                    
                    <div class="image-gallery">
                        <template x-for="plot in filteredPlotsForType('cell_calling')" :key="plot.path">
                            <div class="image-card">
                                <a :href="plot.path" data-lightbox="gallery">
                                    <img :data-src="plot.path" :alt="plot.metadata?.filename || 'Plot'" class="lazy-img">
                                </a>
                                <div class="image-card-title" x-text="plot.metadata?.filename || 'Plot'"></div>
                            </div>
                        </template>
                    </div>
                    
                    <div x-show="filteredPlotsForType('cell_calling').length === 0" class="no-results">
                        No cell calling plots found matching the current filters.
                    </div>
                </div>
                
                <!-- Saturation Section -->
                <div x-show="currentView === 'saturation'" class="content-section">
                    <h1>UMI Saturation Analysis</h1>
                    <p>Saturation curves showing the relationship between sequencing depth and detected features.</p>
                    
                    <div class="image-gallery">
                        <template x-for="plot in filteredPlotsForType('saturation')" :key="plot.path">
                            <div class="image-card">
                                <a :href="plot.path" data-lightbox="gallery">
                                    <img :data-src="plot.path" :alt="plot.metadata?.filename || 'Plot'" class="lazy-img">
                                </a>
                                <div class="image-card-title" x-text="plot.metadata?.filename || 'Plot'"></div>
                            </div>
                        </template>
                    </div>
                </div>
                
                <!-- Per-Cell QC Section - Now with proper hierarchy! -->
                <div x-show="currentView === 'per-cell-qc'" class="content-section">
                    <h1>Per-Cell QC Metrics</h1>
                    <p>Distribution of QC metrics across cells within each sample.</p>
                    
                    <!-- Organized by Sample -> Metric -->
                    <template x-for="[sample, metrics] in Object.entries(getPerCellPlotsBySample())" :key="sample">
                        <div class="sample-section">
                            <h2 class="sample-header" @click="toggleSample(sample)">
                                <span class="toggle-icon" :class="{'expanded': expandedSamples[sample]}">▶</span>
                                <span x-text="sample"></span>
                                <span class="metric-count">(<span x-text="Object.keys(metrics).length"></span> metrics)</span>
                            </h2>
                            
                            <div x-show="expandedSamples[sample]" class="sample-content">
                                <template x-for="[metric, plots] in Object.entries(metrics)" :key="metric">
                                    <div class="metric-subsection">
                                        <h3 x-text="formatMetricName(metric)"></h3>
                                        <div class="plot-grid">
                                            <template x-for="plot in plots" :key="plot.path">
                                                <div class="plot-card">
                                                    <a :href="plot.path" data-lightbox="gallery">
                                                        <img :data-src="plot.path" :alt="plot.metadata?.filename || 'Plot'" class="lazy-img">
                                                    </a>
                                                    <div class="plot-info">
                                                        <span x-text="plot.metadata?.method || ''"></span>
                                                        <span x-show="plot.metadata?.sample_type" x-text="`(${plot.metadata.sample_type})`"></span>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>
                    
                    <div x-show="Object.keys(getPerCellPlotsBySample()).length === 0" class="no-results">
                        No plots found matching the current filters.
                    </div>
                </div>
                
                <!-- Compare Samples Section -->
                <div x-show="currentView === 'compare-samples'" class="content-section">
                    <h1>Compare Samples</h1>
                    <p>View the same metric across all samples for easy comparison.</p>
                    
                    <!-- Organized by Metric -> Samples -->
                    <template x-for="metric in availableMetrics" :key="metric">
                        <div x-show="plotsGroupedByMetric[metric] && plotsGroupedByMetric[metric].length > 0" class="metric-comparison">
                            <h2 x-text="formatMetricName(metric)"></h2>
                            
                            <div class="method-selector" x-data="{selectedMethod: ''}">
                                <label>Method:</label>
                                <select x-model="selectedMethod" class="form-control-sm">
                                    <option value="">All Methods</option>
                                    <template x-for="method in getMethodsForMetric(metric)" :key="method">
                                        <option :value="method" x-text="method"></option>
                                    </template>
                                </select>
                                
                                <div class="comparison-grid">
                                    <template x-for="plot in filterPlotsByMethod(plotsGroupedByMetric[metric], selectedMethod)" :key="plot.path">
                                        <div class="comparison-card">
                                            <div class="comparison-label" x-text="plot.metadata?.sample || 'Sample'"></div>
                                            <a :href="plot.path" data-lightbox="gallery">
                                                <img :data-src="plot.path" :alt="plot.metadata?.filename || 'Plot'" class="comparison-image lazy-img">
                                            </a>
                                            <div class="comparison-info">
                                                <span x-text="plot.metadata?.method || ''"></span> • 
                                                <span x-text="plot.metadata?.source || ''"></span> • 
                                                <span x-text="plot.metadata?.processing || ''"></span>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
                
                <!-- Consolidated Section -->
                <div x-show="currentView === 'consolidated'" class="content-section">
                    <h1>Consolidated QC Metrics</h1>
                    <p>Aggregated metrics across all samples, biological conditions, and wells.</p>
                    
                    <!-- Aggregation Level Tabs -->
                    <div class="tab-container">
                        <div class="tab-buttons">
                            <button @click="consolidatedTab = 'sample'" 
                                    :class="{'active': consolidatedTab === 'sample'}" class="tab-button">
                                Sample Metrics
                            </button>
                            <button @click="consolidatedTab = 'biological_sample'" 
                                    :class="{'active': consolidatedTab === 'biological_sample'}" class="tab-button">
                                Biological Sample Metrics
                            </button>
                            <button @click="consolidatedTab = 'well'" 
                                    :class="{'active': consolidatedTab === 'well'}" class="tab-button">
                                Well Metrics
                            </button>
                        </div>
                        
                        <!-- Data Source Toggle -->
                        <div class="data-source-toggle">
                            <label class="toggle-label">
                                <input type="radio" name="dataSource" value="main_raw" 
                                       x-model="consolidatedDataSource">
                                <span>Main/Raw</span>
                            </label>
                            <label class="toggle-label">
                                <input type="radio" name="dataSource" value="all_merged" 
                                       x-model="consolidatedDataSource">
                                <span>All/Merged</span>
                            </label>
                        </div>
                        
                        <div class="tab-content">
                            <div class="consolidated-content">
                                <template x-for="[groupName, plots] in Object.entries(getConsolidatedPlotsByGroup(consolidatedTab, consolidatedDataSource))" :key="groupName">
                                    <div class="metric-group">
                                        <h3 class="metric-group-header" @click="toggleMetricGroup(groupName)">
                                            <span class="toggle-icon" :class="{'expanded': !collapsedGroups[groupName]}">▶</span>
                                            <span x-text="groupName"></span>
                                            <span class="plot-count">(<span x-text="plots.length"></span> plots)</span>
                                        </h3>
                                        <div x-show="!collapsedGroups[groupName]" class="metric-group-content">
                                            <div class="plot-pairs-grid">
                                                <template x-for="plotPair in groupPlotPairs(plots)" :key="plotPair[0].path">
                                                    <div class="plot-pair">
                                                        <template x-for="plot in plotPair" :key="plot.path">
                                                            <div class="plot-item">
                                                                <a :href="plot.path" data-lightbox="gallery">
                                                                    <img :data-src="plot.path" :alt="plot.variant" class="lazy-img">
                                                                </a>
                                                                <div class="plot-caption" x-text="plot.variant"></div>
                                                            </div>
                                                        </template>
                                                    </div>
                                                </template>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                    
                    <h2>Consolidated Tables</h2>
                    <div id="consolidated-tables"></div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- External Dependencies -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.4/js/lightbox.min.js"></script>
    
    <!-- Alpine.js Application -->
    <script src="js/qc_explorer.js"></script>
    
    <style>
        /* Additional dynamic styles */
        .lazy-img {
            opacity: 0;
            transition: opacity 0.3s;
        }
        .lazy-img.loaded {
            opacity: 1;
        }
        .plot-count, .metric-count {
            font-size: 0.85em;
            opacity: 0.7;
        }
        
        /* Sample section styles */
        .sample-section {
            margin-bottom: 30px;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .sample-header {
            background: #f7f9fa;
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
            margin: 0;
        }
        
        .sample-header:hover {
            background: #e8ecef;
        }
        
        .sample-content {
            padding: 20px;
            background: #fff;
        }
        
        .metric-subsection {
            margin-bottom: 25px;
        }
        
        .metric-subsection h3 {
            margin-bottom: 15px;
            color: #34495e;
            font-size: 16px;
        }
        
        .plot-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .plot-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            overflow: hidden;
        }
        
        .plot-card img {
            width: 100%;
            height: auto;
            display: block;
        }
        
        .plot-info {
            padding: 8px;
            font-size: 12px;
            color: #666;
            text-align: center;
            background: white;
        }
        
        .toggle-icon {
            display: inline-block;
            transition: transform 0.2s;
            font-size: 12px;
        }
        
        .toggle-icon.expanded {
            transform: rotate(90deg);
        }
    </style>
</body>
</html>